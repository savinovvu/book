**@Profile: реализация "под капотом" в Spring**

1. **Мета-аннотация и @Conditional**  
   `@Profile` — это мета-аннотация, помеченная `@Conditional(ProfileCondition.class)`. Ключевой механизм работает через реализацию интерфейса `Condition` в классе `ProfileCondition`.

2. **Класс ProfileCondition**  
   Реализует метод `matches()`, который определяет, должен ли бин/конфигурация быть зарегистрирована на основе активных профилей Spring.

   ```java
   class ProfileCondition implements Condition {
       @Override
       public boolean matches(ConditionContext context, AnnotatedTypeMetadata metadata) {
           // Получение атрибутов аннотации @Profile
           MultiValueMap<String, Object> attrs = metadata.getAllAnnotationAttributes(Profile.class.getName());
           if (attrs != null) {
               for (Object value : attrs.get("value")) {
                   if (context.getEnvironment().acceptsProfiles(Profiles.of((String[]) value))) {
                       return true;
                   }
               }
               return false;
           }
           return true;
       }
   }
   ```

3. **Разбор логики**:
    - **Извлечение профилей**: Извлекаются значения из аннотации `@Profile` (например, `@Profile("dev")` → `"dev"`).
    - **Проверка окружения**: Вызывается `Environment.acceptsProfiles()`, который проверяет, активен ли указанный профиль (или любой из них, если профилей несколько).
    - **Профили с оператором "!"**: Обрабатываются отрицательные проверки (например, `@Profile("!prod")`).

4. **Интеграция с Environment**  
   Spring хранит активные профили в `Environment`, который управляется через:
    - Параметры JVM (`-Dspring.profiles.active=dev`).
    - Переменные окружения.
    - API `ConfigurableEnvironment.setActiveProfiles()`.

5. **Профили как условная логика**  
   Условие `ProfileCondition` выполняется во время парсинга конфигурации (например, при обработке `@Configuration`-классов или `@Bean`-методов). Если условие не совпадает, объявление бина пропускается.

**Пример работы**:
```java
@Configuration
@Profile("dev")
public class DevConfig {
    @Bean
    public DataSource dataSource() {
        return new EmbeddedDatabaseBuilder().build();
    }
}
```
- Если профиль `dev` активен, `ProfileCondition.matches()` вернет `true`, и `DevConfig` будет обработан.
- Если нет — конфигурация игнорируется.

**Важно**:
- Профили могут быть сложными: `@Profile({"dev", "test"})` (логическое ИЛИ).
- В Spring 5+ используется `Profiles.of()` для поддержки сложных выражений (например, `"dev & !cloud"`).
- `@Profile` может применяться к классам и методам, что обеспечивает гибкость.

Таким образом, `@Profile` — это абстракция над более низкоуровневым механизмом `@Conditional`, где `ProfileCondition` связывает аннотацию с текущим состоянием `Environment`.