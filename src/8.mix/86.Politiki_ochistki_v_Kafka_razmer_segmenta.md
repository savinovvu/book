Привет! Давай разберемся с политиками очистки и размером сегментов в Kafka. Это ключевые концепции для управления хранением данных и производительностью.

## Основы сегментов в Kafka

**Сегмент** - это физический файл на диске, часть партиции. Каждая партиция топика делится на несколько сегментов:

```
Топик "orders" → Партиция 0 → [segment_0001.log, segment_0002.log, segment_0003.log]
```

### Размер сегмента
- **По умолчанию**: 1 ГБ (`log.segment.bytes=1073741824`)
- **Активный сегмент**: только один сегмент открыт для записи в каждый момент времени

## Политики очистки (Retention Policies)

### 1. По времени (Time-based)
```properties
# Хранение данных 7 дней (по умолчанию)
log.retention.hours=168

# Или более точные настройки
log.retention.ms=604800000
```

### 2. По размеру (Size-based)
```properties
# Максимальный размер партиции до удаления старых данных
log.retention.bytes=1073741824  # 1 GB

# Размер каждого сегмента
log.segment.bytes=536870912     # 512 MB
```

### 3. Компакция (Compaction)
```properties
log.cleanup.policy=compact
```
Сохраняет только последнее значение для каждого ключа.

## Практические рекомендации

### Оптимальный размер сегмента
```properties
# Для high-throughput топиков
log.segment.bytes=1073741824    # 1 GB

# Для топиков с низким объемом данных
log.segment.bytes=268435456     # 256 MB
```

### Настройки для разных сценариев
```properties
# Логи приложений (7 дней, средние сегменты)
log.retention.hours=168
log.segment.bytes=536870912
log.retention.bytes=-1          # Без ограничения по размеру

# Метрики и мониторинг (30 дней, маленькие сегменты)
log.retention.hours=720
log.segment.bytes=134217728
log.cleanup.policy=delete

# Состояния системы (компакция)
log.cleanup.policy=compact
log.segment.bytes=268435456
log.retention.bytes=-1
```

## Влияние на производительность

### Маленькие сегменты (+/-)
**Плюсы:**
- Быстрее очистка и компакция
- Меньше накладных расходов при поиске

**Минусы:**
- Чаще создание новых сегментов
- Больше открытых файловых дескрипторов

### Большие сегменты (+/-)
**Плюсы:**
- Реже создание сегментов
- Лучшая производительность записи

**Минусы:**
- Медленнее очистка
- Выше задержки при поиске

## Мониторинг и управление

### Проверка сегментов
```bash
# Просмотр сегментов топика
kafka-log-dirs.sh --bootstrap-server localhost:9092 --describe

# Проверка размера топиков
kafka-topics.sh --bootstrap-server localhost:9092 --describe
```

### Аварийные ситуации
```properties
# Экстренное уменьшение retention
log.retention.ms=3600000        # 1 час
log.retention.bytes=536870912   # 512 MB
```

## Лучшие практики

1. **Сегменты 500MB-1GB** - хороший баланс для большинства случаев
2. **Мониторьте disk usage** - настройте алерты при достижении 80% емкости
3. **Разные политики для разных топиков** - кастомизируйте под конкретные нужды
4. **Тестируйте cleanup** - убедитесь, что очистка работает корректно
5. **Учитывайте network latency** - большие сегменты дольше реплицируются

Помни: правильная настройка сегментов и политик очистки напрямую влияет на надежность и производительность Kafka-кластера!