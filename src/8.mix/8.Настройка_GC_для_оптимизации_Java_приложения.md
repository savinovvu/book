# Настройка GC для оптимизации Java-приложения

## 1. Основные понятия и типы сборщиков мусора

### 1.1 Типы GC в современных JVM

**Serial GC**
```bash
-XX:+UseSerialGC
```
- Однопоточный, подходит для приложений с маленькой кучей (<100MB)
- Простые клиентские приложения

**Parallel/Throughput GC**
```bash
-XX:+UseParallelGC
-XX:+UseParallelOldGC
```
- Многопоточный, максимизирует пропускную способность
- Подходит для batch-обработки

**CMS (Concurrent Mark Sweep)**
```bash
-XX:+UseConcMarkSweepGC
```
- Низкие паузы, но фрагментация памяти
- Deprecated в новых версиях Java

**G1 (Garbage First)**
```bash
-XX:+UseG1GC
```
- Баланс между пропускной способностью и паузами
- Рекомендован по умолчанию с Java 9

**ZGC**
```bash
-XX:+UseZGC
```
- Субмиллисекундные паузы (<10ms)
- Для больших куч (от 8GB)

**Shenandoah**
```bash
-XX:+UseShenandoahGC
```
- Низкие паузы, конкурентная компактификация
- Аналогичен ZGC

## 2. Мониторинг и анализ GC

### 2.1 Включение детального логгирования GC
```bash
# Базовое логирование
-Xlog:gc*:file=gc.log:time:filecount=5,filesize=10M

# Детальное логирование для G1
-Xlog:gc*,gc+heap=debug,gc+ergo=debug,gc+age=debug:file=g1.log

# Логирование пауз
-Xlog:gc+phases=debug,gc+pause=info:file=pause.log
```

### 2.2 JVM инструменты мониторинга
```bash
# В реальном времени
jstat -gc <pid> 1s

# Дамп памяти
jmap -heap <pid>
jmap -histo:live <pid>

# Анализ логов GC
jcmd <pid> GC.heap_info
```

### 2.3 JMX мониторинг
```java
// Пример настройки JMX
-Dcom.sun.management.jmxremote
-Dcom.sun.management.jmxremote.port=9010
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false
```

## 3. Настройка G1 GC (рекомендованный)

### 3.1 Базовые настройки
```bash
# Активация G1
-XX:+UseG1GC

# Размер кучи (адаптивная настройка)
-Xms4g -Xmx4g

# Максимальная длительность паузы
-XX:MaxGCPauseMillis=200

# Параллельные потоки для молодого поколения
-XX:ParallelGCThreads=8

# Потоки для конкурентных фаз
-XX:ConcGCThreads=2
```

### 3.2 Продвинутые настройки G1
```bash
# Процент целевого заполнения регионов
-XX:G1HeapRegionSize=8m
-XX:G1NewSizePercent=30
-XX:G1MaxNewSizePercent=60
-XX:G1HeapWastePercent=5

# Настройки смешанных сборок
-XX:G1MixedGCCountTarget=8
-XX:G1MixedGCLiveThresholdPercent=85
-XX:G1RSetUpdatingPauseTimePercent=10

# Включение предсказания пауз
-XX:+G1UseAdaptiveConcRefinement
-XX:+G1EagerReclaim
```

## 4. Настройка ZGC для low-latency приложений

### 4.1 Базовые настройки ZGC
```bash
# Активация ZGC
-XX:+UseZGC

# Размер кучи (рекомендуется >= 8GB)
-Xms16g -Xmx16g

# Количество потоков
-XX:ConcGCThreads=4
-XX:ParallelGCThreads=8

# Настройки для больших страниц
-XX:+UseLargePages
-XX:ZPath=/hugepages

# Логирование
-Xlog:gc:file=zgc.log
```

### 4.2 Продвинутые настройки ZGC
```bash
# Настройка uncommit памяти
-XX:+ZUncommit
-XX:ZUncommitDelay=300

# Настройка compactation
-XX:+ZProactive
-XX:+ZGenerational

# Настройки для контейнеров
-XX:+UseContainerSupport
-XX:ActiveProcessorCount=4
```

## 5. Оптимизация под конкретные сценарии

### 5.1 Web-приложения (высокий throughput)
```bash
-XX:+UseG1GC
-Xms8g -Xmx8g
-XX:MaxGCPauseMillis=100
-XX:ParallelGCThreads=16
-XX:ConcGCThreads=4
-XX:G1ReservePercent=15
-XX:InitiatingHeapOccupancyPercent=35
```

### 5.2 Real-time системы (низкие задержки)
```bash
-XX:+UseZGC
-Xms12g -Xmx12g
-XX:ConcGCThreads=6
-XX:+UseTransparentHugePages
-XX:ZAllocationSpikeTolerance=2.0
```

### 5.3 Big Data обработка (большие данные в памяти)
```bash
-XX:+UseG1GC
-Xms32g -Xmx32g
-XX:MaxGCPauseMillis=500
-XX:G1HeapRegionSize=16m
-XX:G1NewSizePercent=40
-XX:G1MaxNewSizePercent=70
```

## 6. Диагностика проблем

### 6.1 Частые Full GC
```bash
# Мониторинг
jstat -gcutil <pid> 1s

# Решения
- Увеличить -Xmx
- Настроить -XX:InitiatingHeapOccupancyPercent
- Проверить утечки памяти
```

### 6.2 Длинные паузы
```bash
# Диагностика
-XX:+PrintGCApplicationStoppedTime
-XX:+PrintSafepointStatistics

# Решения
- Уменьшить -XX:MaxGCPauseMillis
- Увеличить количество потоков
- Перейти на ZGC/Shenandoah
```

### 6.3 Высокая загрузка CPU
```bash
# Анализ
-XX:+PrintGC
-XX:+PrintGCTaskTimeStamps

# Решения
- Оптимизировать размер молодого поколения
- Настроить баланс между ParallelGCThreads и ConcGCThreads
```

## 7. Best Practices

### 7.1 Общие рекомендации
- Начинать с G1 GC для большинства случаев
- Устанавливать -Xms и -Xmx одинаковыми в production
- Мониторить реальные паузы, а не ориентироваться только на настройки
- Тестировать под нагрузкой, близкой к production

### 7.2 Настройки для контейнеров
```bash
# Docker/Kubernetes
-XX:+UseContainerSupport
-XX:MaxRAMPercentage=75.0
-XX:InitialRAMPercentage=50.0
-XX:MinRAMPercentage=25.0
```

### 7.3 Профилирование в production
```bash
# Включение профилирования
-XX:+FlightRecorder
-XX:StartFlightRecording=duration=60s,filename=myapp.jfr

# Async profiler
-XX:+UnlockDiagnosticVMOptions
-XX:+DebugNonSafepoints
```

## 8. Пример полной конфигурации для enterprise приложения

```bash
# G1 GC конфигурация
-XX:+UseG1GC
-Xms8g -Xmx8g
-XX:MaxGCPauseMillis=150
-XX:ParallelGCThreads=8
-XX:ConcGCThreads=2
-XX:G1HeapRegionSize=8m
-XX:G1NewSizePercent=30
-XX:G1MaxNewSizePercent=50
-XX:G1HeapWastePercent=5
-XX:G1MixedGCLiveThresholdPercent=85
-XX:InitiatingHeapOccupancyPercent=45

# Мониторинг и диагностика
-Xlog:gc*:file=/logs/gc.log:time,uptime,level,tags:filecount=10,filesize=10M
-XX:+HeapDumpOnOutOfMemoryError
-XX:HeapDumpPath=/dumps
-XX:ErrorFile=/logs/hs_err_pid%p.log

# Безопасность и производительность
-XX:+UseStringDeduplication
-XX:+PerfDisableSharedMem
-XX:+AlwaysPreTouch
```

## Заключение

Оптимальная настройка GC требует глубокого понимания характеристик приложения:
- Размер данных в памяти
- Паттерны аллокации
- Требования к latency и throughput
- Аппаратные ресурсы

Рекомендуется проводить нагрузочное тестирование с различными конфигурациями и постоянно мониторить поведение GC в production среде.