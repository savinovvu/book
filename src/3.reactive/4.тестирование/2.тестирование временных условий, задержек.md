Чтобы эффективно тестировать временные условия (например, задержки) в Reactor, используйте **StepVerifier с Virtual Time**. Это позволяет избежать реальных ожиданий, ускоряя тесты. Вот основные подходы:

### 1. **Использование Virtual Time**
Reactor предоставляет механизм виртуального времени для тестирования временных операций без реальных задержек.

**Пример:**
```java
StepVerifier
  .withVirtualTime(() -> 
    Mono.delay(Duration.ofHours(1)) // Задержка 1 час
      .map(it -> "Done after delay")
  )
  .expectSubscription()
  .thenAwait(Duration.ofHours(1)) // "Перемещаем" время вперед
  .expectNext("Done after delay")
  .verifyComplete();
```

**Ключевые методы:**
- `.withVirtualTime()`: Активирует виртуальное время.
- `.thenAwait(Duration)`: Перемещает виртуальное время вперед.
- `.expectNoEvent(Duration)`: Проверяет отсутствие событий в течение указанного времени.

---

### 2. **Тестирование реальных задержек (если необходимо)**
Если требуется проверить поведение с реальным временем, используйте таймауты:

```java
StepVerifier
  .create(
    Mono.delay(Duration.ofSeconds(1))
      .timeout(Duration.ofSeconds(2))
  )
  .expectNext(0L)
  .verifyComplete();
```

---

### 3. **Проверка таймаутов и ошибок**
Тестирование исключений при превышении времени:

```java
StepVerifier
  .create(
    Mono.never() // Бесконечный Mono
      .timeout(Duration.ofMillis(100))
  )
  .expectError(TimeoutException.class)
  .verify();
```

---

### 4. **Тестирование временных окон (например, в Flux)**
Для операторов типа `window`, `buffer` с тайм-аутом:

```java
StepVerifier
  .withVirtualTime(() ->
    Flux.interval(Duration.ofMinutes(1))
      .window(Duration.ofHours(1))
      .flatMap(flux -> flux.count())
  )
  .thenAwait(Duration.ofHours(1))
  .expectNext(60L) // 60 элементов за 1 час
  .verifyComplete();
```

---

### 5. **Советы**
- **Избегайте реальных задержек** в тестах: это замедляет выполнение.
- **Используйте `StepVerifier.withVirtualTime`** для любых операторов времени (`delay`, `interval`, `timeout` и т.д.).
- Для отладки добавьте `.log()` к потоку перед созданием `StepVerifier`.

**Пример полного теста:**
```java
@Test
void testDelayWithVirtualTime() {
  StepVerifier
    .withVirtualTime(() ->
      Mono.delay(Duration.ofDays(1))
        .thenReturn("Success")
    )
    .expectSubscription()
    .thenAwait(Duration.ofDays(1)) // Пропускаем 1 день виртуально
    .expectNext("Success")
    .verifyComplete();
}
```

Этот подход позволяет тестировать сложные временные логику без потери производительности.