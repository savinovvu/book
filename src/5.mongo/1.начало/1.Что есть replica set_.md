# Replica Set в MongoDB

## Что такое Replica Set?

**Replica Set** - это группа MongoDB-процессов (`mongod`), которые поддерживают один и тот же набор данных, обеспечивая:

- **Высокую доступность** (High Availability)
- **Отказоустойчивость** (Fault Tolerance)
- **Масштабируемость чтения** (Read Scalability)

## Архитектура Replica Set

### Типы узлов:

1. **Primary Node**
    - Единственный узел, принимающий операции записи
    - Обрабатывает все операции чтения (по умолчанию)
    - Автоматически выбирается из узлов с данными

2. **Secondary Nodes**
    - Реплицируют данные с primary
    - Могут обслуживать операции чтения
    - Участвуют в выборах primary

3. **Arbiter Node** (опционально)
    - Не хранит данные
    - Участвует только в выборах для обеспечения кворума
    - Используется когда нечетное количество узлов

## Механизм репликации

### Oplog (Operations Log)
- Циркулярный буфер операций записи
- Каждая операция на primary записывается в oplog
- Secondary узлы асинхронно копируют и применяют oplog

```javascript
// Пример просмотра oplog
use local
db.oplog.rs.find().limit(5)
```

## Выборы Primary (Election)

**Триггеры для выборов:**
- Primary становится недоступным
- Добавление нового узла
- Переконфигурация replica set
- Ручная инициализация выборов

```javascript
// Принудительный запуск выборов
rs.stepDown(300) // Primary уходит с поста на 300 секунд
```

## Конфигурация Replica Set

### Базовая настройка:

```javascript
// Инициализация replica set
rs.initiate({
  _id: "rs0",
  members: [
    { _id: 0, host: "mongodb0:27017" },
    { _id: 1, host: "mongodb1:27017" },
    { _id: 2, host: "mongodb2:27017" }
  ]
})
```

### Расширенная конфигурация:

```javascript
rs.reconfig({
  _id: "rs0",
  version: 2,
  members: [
    { _id: 0, host: "mongodb0:27017", priority: 2 },
    { _id: 1, host: "mongodb1:27017", priority: 1 },
    { _id: 2, host: "mongodb2:27017", arbiterOnly: true },
    { _id: 3, host: "mongodb3:27017", hidden: true, priority: 0 }
  ]
})
```

## Стратегии чтения (Read Preferences)

```javascript
// Различные настройки чтения
db.collection.find().readPref("primary") // Только с primary (по умолчанию)
db.collection.find().readPref("primaryPreferred") // В основном primary, но можно secondary
db.collection.find().readPref("secondary") // Только secondary
db.collection.find().readPref("secondaryPreferred") // В основном secondary
db.collection.find().readPref("nearest") // Ближайший узел по сетевой задержке
```

## Практические сценарии

### 1. Аварийное переключение (Failover)
```javascript
// Мониторинг состояния replica set
rs.status()
rs.isMaster()

// Проверка здоровья узлов
db.serverStatus()["repl"]
```

### 2. Добавление нового узла
```javascript
// Добавление secondary узла
rs.add("mongodb3:27017")

// Добавление arbiter
rs.addArb("mongodb-arbiter:27017")
```

### 3. Удаление узла
```javascript
rs.remove("mongodb3:27017")
```

## Мониторинг и диагностика

### Ключевые метрики:
- **Lag time** - задержка репликации
- **Oplog window** - время хранения операций в oplog
- **Election statistics** - статистика выборов
- **Network latency** - сетевая задержка между узлами

```javascript
// Проверка задержки репликации
db.printSlaveReplicationInfo()

// Размер oplog
db.oplog.rs.stats()
```

## Best Practices для Senior-разработчиков

### 1. Размер Oplog
- Минимум 24-72 часа операций
- Рассчитывается исходя из пиковой нагрузки записи

### 2. Распределение узлов
```javascript
// Географическое распределение
rs.reconfig({
  members: [
    { _id: 0, host: "ny-mongo1:27017", priority: 2, tags: { dc: "ny" } },
    { _id: 1, host: "lon-mongo1:27017", priority: 1, tags: { dc: "lon" } },
    { _id: 2, host: "sgp-mongo1:27017", priority: 1, tags: { dc: "sgp" } }
  ]
})
```

### 3. Write Concern
```javascript
// Гарантия записи на большинство узлов
db.products.insert(
  { name: "Product A" },
  { writeConcern: { w: "majority", wtimeout: 5000 } }
)
```

### 4. Read Concern
```javascript
// Чтение с гарантией majority
db.products.find().readConcern("majority")
```

## Ограничения и особенности

- **Максимум 50 узлов** в replica set
- **Максимум 7 голосующих узлов**
- **Только primary принимает записи**
- **Асинхронная репликация** (возможна потеря данных при failover)

## Заключение

Replica Set - фундаментальный механизм MongoDB для обеспечения:
- **Автоматического failover**
- **Распределения нагрузки чтения**
- **Географического распределения**
- **Безопасности данных** через репликацию

Правильная настройка и мониторинг Replica Set критически важны для production-окружений и являются ключевой компетенцией MongoDB Senior-разработчика.